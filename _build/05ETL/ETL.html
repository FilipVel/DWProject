---
redirect_from:
  - "/05etl/etl"
interact_link: content/05ETL/ETL.ipynb
kernel_name: python3
kernel_path: content/05ETL
has_widgets: false
title: |-
  ETL Process
pagenum: 4
prev_page:
  url: /04Scheduled/scheduled.html
next_page:
  url: /06Tableau/Tableau.html
suffix: .ipynb
search: script python whole etl process conducted through connecting both mongodb postgresql databases using pymongo sqlachemy respectively resulting data finally stored warehouse repetitive well executing every second am achieved following cron command pathtoscript py click toggle button code

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">ETL Process</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The whole ETL process is conducted through a Python script connecting both the MongoDB and the PostgreSQL databases using <strong>pymongo</strong> and <strong>sqlachemy</strong> respectively. The resulting data is finally stored in the Warehouse. This is a repetitive script as well, executing every second day at <strong>10:05AM</strong> .This is achieved with the following cron command:</p>

<pre><code>5 10 */2 * * python3 path_to_script/script.py</code></pre>
<p>Click the toggle button to see the code</p>

</div>
</div>
</div>
</div>

<div class="jb_cell tag_hide_input">

<div class="cell border-box-sizing code_cell rendered tag_hide_input">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span><span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">KNNImputer</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">countries_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="s1">&#39;Italy&#39;</span><span class="p">,</span><span class="s1">&#39;de&#39;</span><span class="p">:</span><span class="s1">&#39;Germany&#39;</span><span class="p">,</span><span class="s1">&#39;fr&#39;</span><span class="p">:</span><span class="s1">&#39;France&#39;</span><span class="p">,</span><span class="s1">&#39;cz&#39;</span><span class="p">:</span><span class="s1">&#39;Czech Republic&#39;</span><span class="p">,</span><span class="s1">&#39;tr&#39;</span><span class="p">:</span><span class="s1">&#39;Turkey&#39;</span><span class="p">,</span><span class="s1">&#39;at&#39;</span><span class="p">:</span><span class="s1">&#39;Austria&#39;</span><span class="p">,</span><span class="s1">&#39;lu&#39;</span><span class="p">:</span><span class="s1">&#39;Luxemburg&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;be&#39;</span><span class="p">:</span><span class="s1">&#39;Belgium&#39;</span><span class="p">,</span><span class="s1">&#39;nl&#39;</span><span class="p">:</span><span class="s1">&#39;Netherlands&#39;</span><span class="p">,</span><span class="s1">&#39;gb&#39;</span><span class="p">:</span><span class="s1">&#39;Great Britain&#39;</span><span class="p">,</span><span class="s1">&#39;es&#39;</span><span class="p">:</span><span class="s1">&#39;Spain&#39;</span><span class="p">,</span><span class="s1">&#39;bg&#39;</span><span class="p">:</span><span class="s1">&#39;Bulgaria&#39;</span><span class="p">,</span><span class="s1">&#39;ru&#39;</span><span class="p">:</span><span class="s1">&#39;Russia&#39;</span><span class="p">,</span><span class="s1">&#39;pl&#39;</span><span class="p">:</span><span class="s1">&#39;Poland&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;ro&#39;</span><span class="p">:</span><span class="s1">&#39;Romania&#39;</span><span class="p">,</span><span class="s1">&#39;hu&#39;</span><span class="p">:</span><span class="s1">&#39;Hungary&#39;</span><span class="p">}</span>

<span class="n">DATABASE_URI</span> <span class="o">=</span> <span class="s1">&#39;postgres+psycopg2://&lt;name&gt;:&lt;pass&gt;@&lt;IP_address&gt;/&lt;db_name&gt;&#39;</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span> 
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URI</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;mongodb+srv://&lt;User&gt;:&lt;Password&gt;@dwprojectcluster.lpqbf.mongodb.net/cars_database?retryWrites=true&amp;w=majority&#39;</span><span class="p">)</span>

<span class="n">df_cars</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">cars</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
<span class="n">df_cars</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_cars</span> <span class="o">=</span> <span class="n">df_cars</span><span class="p">[</span><span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Loaded_in_DW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>
<span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>

<span class="n">df_ads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
<span class="n">df_ads</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">df_sellers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">sellers</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
<span class="n">df_sellers</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_sellers</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sellers</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<span class="n">df_ads</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CarID&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_cars</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_sellers</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stignav&quot;</span><span class="p">)</span>
<span class="n">df_cities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;cities.csv&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I posle gradovi&quot;</span><span class="p">)</span>
<span class="n">df_cities_eu</span> <span class="o">=</span> <span class="n">df_cities</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;at&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;nl&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;be&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;lu&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;pl&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;ru&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;es&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;fr&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;cz&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;gb&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;cz&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;hu&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
                             <span class="o">|</span> <span class="n">df_cities</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">)]</span>

<span class="n">df_cities_eu</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">sellers_extended</span> <span class="o">=</span> <span class="n">df_sellers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_cities_eu</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;City&#39;</span><span class="p">),</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_other&#39;</span><span class="p">)</span>
<span class="n">sellers_extended</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s1">&#39;Country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">countries_dict</span><span class="p">)</span>
<span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>


<span class="n">join1</span> <span class="o">=</span> <span class="n">df_cars</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ads</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;CarID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">join2</span> <span class="o">=</span> <span class="n">join1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sellers_extended</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">final</span> <span class="o">=</span> <span class="n">join2</span><span class="p">[[</span><span class="s1">&#39;Make&#39;</span><span class="p">,</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="s1">&#39;SellerID&#39;</span><span class="p">,</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;Mileage&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">]]</span>
<span class="n">final</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># remove rows which do not have both Make and Model </span>
<span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
<span class="c1"># these are the removed documents (rows of the dataframe)</span>
<span class="n">documents_without_make_and_model</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>

<span class="c1"># performing imputation on a different dataframe</span>
<span class="n">imputation_dataframe</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># SellerID can&#39;t contribute to the imputation</span>
<span class="n">imputation_dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1"># one-hot encoding the categorical variables, so KNN can be used for imputing</span>
<span class="n">imputation_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">imputation_dataframe</span><span class="p">,</span>
                                      <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Make&#39;</span><span class="p">,</span> <span class="s1">&#39;Model&#39;</span><span class="p">],</span>
                                      <span class="n">dummy_na</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># can be done without a pipeline, but in case of more steps in the future, the structure remains a pipeline</span>
<span class="n">imputation_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;iterative_imputer&#39;</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">(</span><span class="n">missing_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                                                         <span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                                                                         <span class="n">weights</span> <span class="o">=</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
                                                                         <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;nan_euclidean&#39;</span><span class="p">,</span>
                                                                         <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                                         <span class="n">add_indicator</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))])</span>
<span class="c1"># applying pipeline and creating resulting dataframe</span>
<span class="n">imputed_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">imputation_pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">imputation_dataframe</span><span class="p">),</span>
                                 <span class="n">columns</span> <span class="o">=</span> <span class="n">imputation_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                 <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>

<span class="c1"># adding the imputed columns to the original dataframe</span>
<span class="n">final</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Mileage&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">final</span><span class="p">[</span><span class="s1">&#39;Mileage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputed_dataframe</span><span class="p">[</span><span class="s1">&#39;Mileage&#39;</span><span class="p">]</span>
<span class="n">final</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputed_dataframe</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span>

<span class="c1"># replacing null values with appropriate value defined by the team</span>
<span class="n">final</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>
<span class="n">final</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>
<span class="n">final</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">})</span>

<span class="n">model_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>
<span class="n">marka_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;marka&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>
<span class="n">seller_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;seller&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>
<span class="n">zemja_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>

<span class="n">left_join</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;make&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Make&#39;</span><span class="p">]))})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">marka_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;skey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;ime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;make&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;skey&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;marka&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">marka_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;marka&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>

<span class="n">left_join</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;model&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_cars</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]))})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">model_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;skey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;ime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;skey&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
<span class="n">model_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>


<span class="n">left_join</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;zemja&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]))})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">zemja_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;skey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;ime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;zemja&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;skey&#39;</span><span class="p">,</span> <span class="s1">&#39;zemja&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
<span class="n">zemja_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>

<span class="n">left_join</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;zemja&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sellers_extended</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]))})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">zemja_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;skey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;ime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;zemja&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;skey&#39;</span><span class="p">,</span> <span class="s1">&#39;zemja&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
<span class="n">zemja_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;zemja&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>


<span class="n">left_join</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_sellers</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">],</span> <span class="n">df_sellers</span><span class="p">[</span><span class="s1">&#39;Vendor&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seller_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;odb_sellerid&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;skey&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;odb_sellerid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;vendorname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;Vendor&#39;</span><span class="p">]</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;skey&#39;</span><span class="p">,</span> <span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="s1">&#39;Vendor&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">left_join</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;seller&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
<span class="n">seller_postgre</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s1">&#39;seller&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">)</span>


<span class="n">merged</span> <span class="o">=</span> <span class="n">final</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seller_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;SellerID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;odb_sellerid&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span> \
     <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">zemja_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>  \
     <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">marka_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;Make&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span> \
     <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">model_postgre</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ime&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">)[[</span><span class="s1">&#39;skey_x&#39;</span><span class="p">,</span> <span class="s1">&#39;skey_y&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Mileage&#39;</span><span class="p">]]</span>
<span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;seller_skey&#39;</span><span class="p">,</span> <span class="s1">&#39;marka_skey&#39;</span><span class="p">,</span> <span class="s1">&#39;zemja_skey&#39;</span><span class="p">,</span> <span class="s1">&#39;model_skey&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span><span class="s1">&#39;Mileage&#39;</span><span class="p">]</span>


<span class="n">fact1</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;seller_skey&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fact2</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;zemja_skey&#39;</span><span class="p">,</span><span class="s1">&#39;model_skey&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fact1</span> <span class="o">=</span> <span class="n">fact1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;marka_skey&#39;</span><span class="p">,</span> <span class="s1">&#39;zemja_skey&#39;</span><span class="p">,</span><span class="s1">&#39;model_skey&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">avg_price</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">),</span>
    <span class="n">car_count</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>
    <span class="n">avg_mileage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Mileage&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>



<span class="n">fact2</span> <span class="o">=</span>  <span class="n">fact2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;seller_skey&#39;</span><span class="p">,</span> <span class="s1">&#39;marka_skey&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">car_count</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">),</span>

<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;TRUNCATE TABLE fact_make_model_country&quot;</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;TRUNCATE TABLE fact_seller_make&quot;</span><span class="p">)</span>

<span class="n">fact1</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;fact_make_model_country&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
<span class="n">fact2</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;fact_seller_make&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>


<span class="n">finish</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">log</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="s1">&#39;Finish&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">finish</span><span class="p">]}</span>
<span class="n">df_log</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
<span class="n">df_log</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;log_table&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

 


    </main>
    