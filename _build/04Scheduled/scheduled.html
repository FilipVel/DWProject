---
redirect_from:
  - "/04scheduled/scheduled"
interact_link: content/04Scheduled/scheduled.ipynb
kernel_name: python3
kernel_path: content/04Scheduled
has_widgets: false
title: |-
  Scheduled Web Scraping
pagenum: 3
prev_page:
  url: /03Initial/initial.html
next_page:
  url: /05ETL/ETL.html
suffix: .ipynb
search: script code comes scheduled web scraping made improvments current data ads sellers collections also retrieved put digitalocean droplet executed every am using cron command usr bin python scriptpath py br click toggle button expand

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Scheduled Web Scraping</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When it comes to script for scheduled web scraping we have made some improvments in the code. With the current code, data for the <em>ads</em> and <em>sellers</em> collections is also retrieved. This script is put on the DigitalOcean droplet and it is executed every day at <strong>08:05AM</strong> using this <strong>cron</strong> command:</p>

<pre><code>5 8 * * * usr/bin/python script_path/script.py</code></pre>
<p><br>
Click the toggle button to expand the code</p>

</div>
</div>
</div>
</div>

<div class="jb_cell tag_hide_input">

<div class="cell border-box-sizing code_cell rendered tag_hide_input">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span> <span class="k">as</span> <span class="n">uReq</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span> <span class="k">as</span> <span class="n">soup</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit</span><span class="se">\</span>
<span class="s1">    /537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&#39;</span><span class="p">})</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Make&quot;</span><span class="p">,</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Body&quot;</span><span class="p">,</span> <span class="s2">&quot;First Registration&quot;</span><span class="p">,</span> <span class="s2">&quot;Fuel&quot;</span><span class="p">,</span> <span class="s2">&quot;Mileage&quot;</span><span class="p">,</span> <span class="s2">&quot;Power(hp)&quot;</span><span class="p">,</span> <span class="s2">&quot;Gearing Type&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;Warranty&quot;</span><span class="p">,</span> <span class="s2">&quot;Full Service&quot;</span><span class="p">,</span> <span class="s2">&quot;Non-smoking Vehicle&quot;</span><span class="p">,</span> <span class="s2">&quot;Model Code&quot;</span><span class="p">,</span> <span class="s2">&quot;ABS&quot;</span><span class="p">,</span> <span class="s2">&quot;Driver-side airbag&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Passenger-side airbag&quot;</span><span class="p">,</span> <span class="s2">&quot;Sunroof&quot;</span><span class="p">,</span> <span class="s2">&quot;Radio&quot;</span><span class="p">,</span> <span class="s2">&quot;4WD&quot;</span><span class="p">,</span> <span class="s2">&quot;Power windows&quot;</span><span class="p">,</span> <span class="s2">&quot;Alloy wheels&quot;</span><span class="p">,</span> <span class="s2">&quot;Central door lock&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Alarm system&quot;</span><span class="p">,</span> <span class="s2">&quot;Navigation system&quot;</span><span class="p">,</span> <span class="s2">&quot;Immobilizer&quot;</span><span class="p">,</span> <span class="s2">&quot;Side airbag&quot;</span><span class="p">,</span> <span class="s2">&quot;Seat heating&quot;</span><span class="p">,</span> <span class="s2">&quot;Disabled accessible&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Cruise control&quot;</span><span class="p">,</span> <span class="s2">&quot;Xenon headlights&quot;</span><span class="p">,</span> <span class="s2">&quot;On-board computer&quot;</span><span class="p">,</span> <span class="s2">&quot;Electronic stability control&quot;</span><span class="p">,</span> <span class="s2">&quot;Fog lights&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Trailer hitch&quot;</span><span class="p">,</span> <span class="s2">&quot;Air conditioning&quot;</span><span class="p">,</span> <span class="s2">&quot;Roof rack&quot;</span><span class="p">,</span> <span class="s2">&quot;Power steering&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic climate control&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Traction control&quot;</span><span class="p">,</span> <span class="s2">&quot;Electrically adjustable seats&quot;</span><span class="p">,</span> <span class="s2">&quot;MP3&quot;</span><span class="p">,</span> <span class="s2">&quot;Panorama roof&quot;</span><span class="p">,</span> <span class="s2">&quot;Auxiliary heating&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Sport package&quot;</span><span class="p">,</span> <span class="s2">&quot;Start-stop system&quot;</span><span class="p">,</span> <span class="s2">&quot;Multi-function steeripopng wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Daytime running lights&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Sport suspension&quot;</span><span class="p">,</span> <span class="s2">&quot;Sport seats&quot;</span><span class="p">,</span> <span class="s2">&quot;Adaptive headlights&quot;</span><span class="p">,</span> <span class="s2">&quot;Ski bag&quot;</span><span class="p">,</span> <span class="s2">&quot;Adaptive Cruise Control&quot;</span><span class="p">,</span> <span class="s2">&quot;Armrest&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Electrically heated windshield&quot;</span><span class="p">,</span> <span class="s2">&quot;Heated steering wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Hill Holder&quot;</span><span class="p">,</span> <span class="s2">&quot;Digital radio&quot;</span><span class="p">,</span> <span class="s2">&quot;LED Headlights&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Electric tailgate&quot;</span><span class="p">,</span> <span class="s2">&quot;LED Daytime Running Lights&quot;</span><span class="p">,</span> <span class="s2">&quot;Leather steering wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Air suspension&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Massage seats&quot;</span><span class="p">,</span> <span class="s2">&quot;Night view assist&quot;</span><span class="p">,</span> <span class="s2">&quot;Tire pressure monitoring system&quot;</span><span class="p">,</span> <span class="s2">&quot;Keyless central door lock&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Lane departure warning system&quot;</span><span class="p">,</span> <span class="s2">&quot;Blind spot monitor&quot;</span><span class="p">,</span> <span class="s2">&quot;Touch screen&quot;</span><span class="p">,</span> <span class="s2">&quot;USB&quot;</span><span class="p">,</span> <span class="s2">&quot;Traffic sign recognition&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Electrical side mirrors&quot;</span><span class="p">,</span> <span class="s2">&quot;Bluetooth&quot;</span><span class="p">,</span> <span class="s2">&quot;Isofix&quot;</span><span class="p">,</span> <span class="s2">&quot;Rain sensor&quot;</span><span class="p">,</span> <span class="s2">&quot;Parking assist system sensors front&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Parking assist system sensors rear&quot;</span><span class="p">,</span> <span class="s2">&quot;Parking assist system camera&quot;</span><span class="p">,</span> <span class="s2">&quot;Parking assist system self-steering&quot;</span><span class="p">,</span>
           <span class="s2">&quot;CD player&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">]</span>

<span class="n">car_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Make&quot;</span><span class="p">,</span> <span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="s2">&quot;Body&quot;</span><span class="p">,</span> <span class="s2">&quot;First Registration&quot;</span><span class="p">,</span> <span class="s2">&quot;Fuel&quot;</span><span class="p">,</span> <span class="s2">&quot;Mileage&quot;</span><span class="p">,</span> <span class="s2">&quot;Power(hp)&quot;</span><span class="p">,</span> <span class="s2">&quot;Gearing Type&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span> <span class="s2">&quot;Warranty&quot;</span><span class="p">,</span> <span class="s2">&quot;Full Service&quot;</span><span class="p">,</span> <span class="s2">&quot;Non-smoking Vehicle&quot;</span><span class="p">,</span> <span class="s2">&quot;Model Code&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">]</span>

<span class="n">eq_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AdID&quot;</span><span class="p">,</span> <span class="s2">&quot;ABS&quot;</span><span class="p">,</span> <span class="s2">&quot;Driver-side airbag&quot;</span><span class="p">,</span> <span class="s2">&quot;Passenger-side airbag&quot;</span><span class="p">,</span> <span class="s2">&quot;Sunroof&quot;</span><span class="p">,</span> <span class="s2">&quot;Radio&quot;</span><span class="p">,</span> <span class="s2">&quot;4WD&quot;</span><span class="p">,</span> <span class="s2">&quot;Power windows&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Alloy wheels&quot;</span><span class="p">,</span> <span class="s2">&quot;Central door lock&quot;</span><span class="p">,</span> <span class="s2">&quot;Alarm system&quot;</span><span class="p">,</span> <span class="s2">&quot;Navigation system&quot;</span><span class="p">,</span> <span class="s2">&quot;Immobilizer&quot;</span><span class="p">,</span> <span class="s2">&quot;Side airbag&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Seat heating&quot;</span><span class="p">,</span> <span class="s2">&quot;Disabled accessible&quot;</span><span class="p">,</span> <span class="s2">&quot;Cruise control&quot;</span><span class="p">,</span> <span class="s2">&quot;Xenon headlights&quot;</span><span class="p">,</span> <span class="s2">&quot;On-board computer&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Electronic stability control&quot;</span><span class="p">,</span> <span class="s2">&quot;Fog lights&quot;</span><span class="p">,</span> <span class="s2">&quot;Trailer hitch&quot;</span><span class="p">,</span> <span class="s2">&quot;Air conditioning&quot;</span><span class="p">,</span> <span class="s2">&quot;Roof rack&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Power steering&quot;</span><span class="p">,</span> <span class="s2">&quot;Automatic climate control&quot;</span><span class="p">,</span> <span class="s2">&quot;Traction control&quot;</span><span class="p">,</span> <span class="s2">&quot;Electrically adjustable seats&quot;</span><span class="p">,</span> <span class="s2">&quot;MP3&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Panorama roof&quot;</span><span class="p">,</span> <span class="s2">&quot;Auxiliary heating&quot;</span><span class="p">,</span> <span class="s2">&quot;Sport package&quot;</span><span class="p">,</span> <span class="s2">&quot;Start-stop system&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Multi-function steering wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Daytime running lights&quot;</span><span class="p">,</span> <span class="s2">&quot;Sport suspension&quot;</span><span class="p">,</span> <span class="s2">&quot;Sport seats&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Adaptive headlights&quot;</span><span class="p">,</span> <span class="s2">&quot;Ski bag&quot;</span><span class="p">,</span> <span class="s2">&quot;Adaptive Cruise Control&quot;</span><span class="p">,</span> <span class="s2">&quot;Armrest&quot;</span><span class="p">,</span> <span class="s2">&quot;Electrically heated windshield&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Heated steering wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Hill Holder&quot;</span><span class="p">,</span> <span class="s2">&quot;Digital radio&quot;</span><span class="p">,</span> <span class="s2">&quot;LED Headlights&quot;</span><span class="p">,</span> <span class="s2">&quot;Electric tailgate&quot;</span><span class="p">,</span>
              <span class="s2">&quot;LED Daytime Running Lights&quot;</span><span class="p">,</span> <span class="s2">&quot;Leather steering wheel&quot;</span><span class="p">,</span> <span class="s2">&quot;Air suspension&quot;</span><span class="p">,</span> <span class="s2">&quot;Massage seats&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Night view assist&quot;</span><span class="p">,</span> <span class="s2">&quot;Tire pressure monitoring system&quot;</span><span class="p">,</span> <span class="s2">&quot;Keyless central door lock&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Lane departure warning system&quot;</span><span class="p">,</span> <span class="s2">&quot;Blind spot monitor&quot;</span><span class="p">,</span> <span class="s2">&quot;Touch screen&quot;</span><span class="p">,</span> <span class="s2">&quot;USB&quot;</span><span class="p">,</span> <span class="s2">&quot;Traffic sign recognition&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Electrical side mirrors&quot;</span><span class="p">,</span> <span class="s2">&quot;Bluetooth&quot;</span><span class="p">,</span> <span class="s2">&quot;Isofix&quot;</span><span class="p">,</span> <span class="s2">&quot;Rain sensor&quot;</span><span class="p">,</span> <span class="s2">&quot;Parking assist system sensors front&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Parking assist system sensors rear&quot;</span><span class="p">,</span> <span class="s2">&quot;Parking assist system camera&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Parking assist system self-steering&quot;</span><span class="p">,</span> <span class="s2">&quot;CD player&quot;</span><span class="p">]</span>

<span class="n">AD_METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CarID&quot;</span><span class="p">,</span> <span class="s2">&quot;SellerID&quot;</span><span class="p">,</span> <span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;URL&quot;</span><span class="p">]</span>
<span class="n">SELLER_METRICS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SellerID&quot;</span><span class="p">,</span> <span class="s2">&quot;Vendor&quot;</span><span class="p">,</span> <span class="s2">&quot;City&quot;</span><span class="p">,</span> <span class="s2">&quot;ZipCode&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">]</span>

<span class="n">old_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;_old&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
<span class="n">old_ads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;_old&#39;</span><span class="p">,</span> <span class="n">AD_METRICS</span><span class="p">))</span>
<span class="n">old_sellers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;_old&#39;</span><span class="p">,</span> <span class="n">SELLER_METRICS</span><span class="p">))</span>



<span class="n">list_of_valid_years</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">2021</span><span class="p">)]</span>

<span class="n">model_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">makes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Opel&#39;</span><span class="p">,</span> <span class="s1">&#39;Audi&#39;</span><span class="p">,</span> <span class="s1">&#39;Volkswagen&#39;</span><span class="p">,</span> <span class="s1">&#39;BMW&#39;</span><span class="p">,</span> <span class="s1">&#39;Renault&#39;</span><span class="p">,</span> <span class="s1">&#39;Mercedes-Benz&#39;</span><span class="p">,</span> <span class="s1">&#39;Seat&#39;</span><span class="p">,</span> <span class="s1">&#39;Fiat&#39;</span><span class="p">]</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.autoscout24.com&quot;</span>

<span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">df_car_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">car_metrics</span><span class="p">)</span>
<span class="n">df_eq_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">eq_metrics</span><span class="p">)</span>
<span class="n">df_ads_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">AD_METRICS</span><span class="p">)</span>
<span class="n">df_seller_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">SELLER_METRICS</span><span class="p">)</span>

<span class="c1"># connecting to mongodb with mongo clinet</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s1">&#39;mongodb://&lt;UserName&gt;:&lt;Password&gt;@&#39;</span>
                    <span class="s1">&#39;dwprojectcluster-shard-00-00.lpqbf.mongodb.net:27017,&#39;</span>
                     <span class="s1">&#39;dwprojectcluster-shard-00-01.lpqbf.mongodb.net:27017,&#39;</span>
                     <span class="s1">&#39;dwprojectcluster-shard-00-02.lpqbf.mongodb.net:27017/&#39;</span>
                     <span class="s1">&#39;&lt;dbname&gt;?ssl=true&amp;replicaSet=atlas-672mwy-shard-0&#39;</span>
                     <span class="s1">&#39;&amp;authSource=admin&amp;retryWrites=true&amp;w=majority&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">return_ads_sellers</span><span class="p">(</span><span class="n">url1</span><span class="p">):</span>
    <span class="n">TMP_AD_DICT</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">TMP_SELLER_DICT</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">AD_URL</span> <span class="o">=</span> <span class="n">url1</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">uClient</span> <span class="o">=</span> <span class="n">uReq</span><span class="p">(</span><span class="n">AD_URL</span><span class="p">)</span>
        <span class="n">page_html</span> <span class="o">=</span> <span class="n">uClient</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">uClient</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error occured at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">AD_URL</span><span class="p">))</span>

    <span class="n">ad_soup</span> <span class="o">=</span> <span class="n">soup</span><span class="p">(</span><span class="n">page_html</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

    <span class="n">details</span> <span class="o">=</span> <span class="n">ad_soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-item&quot;</span><span class="p">})[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;as24-tracking&quot;</span><span class="p">)</span>
    <span class="n">stage_data</span> <span class="o">=</span> <span class="n">ad_soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-stage-data&quot;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">PRICE</span> <span class="o">=</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-price&quot;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;CarID&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span> <span class="s2">&quot;classified_productID&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;as24-tracking-value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span>
    <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;SellerID&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span> <span class="s2">&quot;classified_customerID&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;as24-tracking-value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span>
    <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-detail-title sc-ellipsis&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">PRICE</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-stealth-link&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad_soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;dd&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AD_URL</span>
    <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]:</span>
        <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]:</span>
        <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMP_AD_DICT</span><span class="p">[</span><span class="s2">&quot;Title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vendor</span> <span class="o">=</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;vendor-company-name&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">vendor</span> <span class="o">=</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;vendor-private-seller-title&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping&quot;</span><span class="p">)</span>

    <span class="n">city</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;vendor-contact-city&quot;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">zip_code</span> <span class="o">=</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;vendor-contact-city&quot;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">stage_data</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;vendor-contact-country&quot;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">country</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>

    <span class="n">TMP_SELLER_DICT</span><span class="p">[</span><span class="s2">&quot;SellerID&quot;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span> <span class="s2">&quot;classified_customerID&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;as24-tracking-value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span>
    <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">TMP_SELLER_DICT</span><span class="p">[</span><span class="s2">&quot;Vendor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vendor</span>
    <span class="n">TMP_SELLER_DICT</span><span class="p">[</span><span class="s2">&quot;City&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
    <span class="n">TMP_SELLER_DICT</span><span class="p">[</span><span class="s2">&quot;ZipCode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zip_code</span><span class="p">)</span>
    <span class="n">TMP_SELLER_DICT</span><span class="p">[</span><span class="s2">&quot;Country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">country</span>

    <span class="k">return</span> <span class="n">TMP_AD_DICT</span><span class="p">,</span> <span class="n">TMP_SELLER_DICT</span>


<span class="k">def</span> <span class="nf">baraj</span><span class="p">(</span><span class="n">make</span><span class="p">):</span>
    <span class="n">local_df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">local_df_car_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">car_metrics</span><span class="p">)</span>
    <span class="n">local_df_eq_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">eq_metrics</span><span class="p">)</span>
    <span class="n">local_df_ads_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">AD_METRICS</span><span class="p">)</span>
    <span class="n">local_df_seller_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">SELLER_METRICS</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>

        <span class="c1"># srotirano po most recent</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.autoscout24.com/lst/</span><span class="si">{</span><span class="n">make</span><span class="si">}</span><span class="s2">?sort=age&amp;desc=0&amp;ustate=N%2CU&amp;size=20&amp;page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&amp;atype=C&amp;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">html_soup1</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;cl-empty-listings-summary&#39;</span><span class="p">})</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print(base_url)</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;data-item-name&quot;</span><span class="p">:</span> <span class="s2">&quot;detail-page-link&quot;</span><span class="p">}):</span>  <span class="c1"># sekoj poseben oglas</span>

                <span class="n">r</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">url1</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span>  <span class="c1"># linkot od oglasot</span>
                <span class="c1">#print(url1)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url1</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="n">html_soup1</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;as24-tracking&quot;</span><span class="p">)</span>
                <span class="n">ID</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="k">if</span> <span class="s2">&quot;classified_productID&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;as24-tracking-value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span>
                <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;sc-font-l cldt-stage-primary-keyfact&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Mileage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;basicDataFirstRegistrationValue&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="s2">&quot;First Registration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_of_valid_years</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Older Registration; Ignoring ad!&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;sc-font-m cldt-stage-primary-keyfact&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Power(hp)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))</span>

                <span class="n">r</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">html_soup1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;cldt-price&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

                <span class="c1"># dodatna oprema</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cldt-equipment-block sc-grid-col-3 sc-grid-col-m-4 sc-grid-col-s-12 sc-pull-left&quot;</span><span class="p">}):</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">):</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">lst1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">lst2</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;dl&#39;</span><span class="p">):</span>  <span class="c1"># paramentri</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">):</span>
                        <span class="n">lst1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">html_soup1</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;dl&#39;</span><span class="p">):</span>  <span class="c1"># vrednosti</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                            <span class="n">lst2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lst2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst1</span><span class="p">)):</span>  <span class="c1"># spojuvanje</span>
                    <span class="k">if</span> <span class="n">lst1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Displacement&#39;</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">lst1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lst2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">lst1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;First Registration&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">lst1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lst2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">car_final</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">eq_final</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">final</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span>
                <span class="n">car_final</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span>
                <span class="n">eq_final</span><span class="p">[</span><span class="s2">&quot;AdID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span>

                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;ID&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">car_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">car_final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;ID&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">car_final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">eq_metrics</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">eq_final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;AdID&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eq_final</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">local_df_metrics</span> <span class="o">=</span> <span class="n">local_df_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">final</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">local_df_car_metrics</span> <span class="o">=</span> <span class="n">local_df_car_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">eq_final</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">local_df_eq_metrics</span> <span class="o">=</span> <span class="n">local_df_eq_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">car_final</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">ad_dict</span><span class="p">,</span> <span class="n">seller_dict</span> <span class="o">=</span> <span class="n">return_ads_sellers</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">sellers</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s1">&#39;SellerID&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ad_dict</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">])})</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">local_df_seller_metrics</span> <span class="o">=</span> <span class="n">local_df_seller_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">seller_dict</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                   <span class="c1"># print(&quot;Seller with ID: {0} already exists!&quot;.format(ad_dict[&#39;SellerID&#39;]))</span>


                <span class="n">local_df_ads_metrics</span> <span class="o">=</span> <span class="n">local_df_ads_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ad_dict</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Empty query for make </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">make</span><span class="p">))</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">local_df_metrics</span><span class="p">,</span> <span class="n">local_df_car_metrics</span><span class="p">,</span> <span class="n">local_df_eq_metrics</span><span class="p">,</span> <span class="n">local_df_seller_metrics</span><span class="p">,</span> <span class="n">local_df_ads_metrics</span>


<span class="k">for</span> <span class="n">make</span> <span class="ow">in</span> <span class="n">makes</span><span class="p">:</span>
    <span class="n">iter_df_metrics</span><span class="p">,</span> <span class="n">iter_df_car_metrics</span><span class="p">,</span> <span class="n">iter_df_eq_metrics</span><span class="p">,</span> <span class="n">iter_df_seller_metrics</span><span class="p">,</span> <span class="n">iter_df_ads_metrics</span> <span class="o">=</span> <span class="n">baraj</span><span class="p">(</span><span class="n">make</span><span class="p">)</span>
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_df_metrics</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_car_metrics</span> <span class="o">=</span> <span class="n">df_car_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_df_car_metrics</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_eq_metrics</span> <span class="o">=</span> <span class="n">df_eq_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_df_eq_metrics</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_seller_metrics</span> <span class="o">=</span> <span class="n">df_seller_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_df_seller_metrics</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_ads_metrics</span> <span class="o">=</span> <span class="n">df_ads_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_df_ads_metrics</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FINISHING&quot;</span><span class="p">)</span>
    
<span class="n">which_files_to_load</span> <span class="o">=</span> <span class="s1">&#39;metrics only&#39;</span>

<span class="k">if</span> <span class="n">which_files_to_load</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
    <span class="c1"># list_of_dfs = [df_metrics, df_car_metrics, df_eq_metrics]</span>
    <span class="n">list_of_dfs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty list for now, no protocols specified for other files</span>
    <span class="n">list_of_ads_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_of_sellers_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">list_of_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_metrics</span><span class="p">]</span>         
    <span class="n">list_of_ads_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_ads_metrics</span><span class="p">]</span>
    <span class="n">list_of_sellers_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_seller_metrics</span><span class="p">]</span>

<span class="c1"># TODO: if loading all files, specify loading protocol</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">list_of_dfs</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Loaded_in_DW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1">#Check for present values in the database</span>
    <span class="n">df_old</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">cars</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">old_metrics</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_old</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ID_old&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;ID_old&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">left_join</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">83</span><span class="p">]</span>
    
    <span class="c1"># Relativno posporo resenie od df.to_dict(&#39;records&#39;), megjutoa za razlika od nego gi ignorira NaN vrednostite.</span>
    <span class="n">clean_dict_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No cars to be inserted&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">cars</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span>
        
<span class="c1">#insert ads to mongo</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">list_of_ads_dfs</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Loaded_in_DW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">df_old</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">old_ads</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CarID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CarID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_old</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CarID&quot;</span><span class="p">,</span> <span class="s2">&quot;SellerID&quot;</span><span class="p">],</span> <span class="n">right_on</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;CarID_old&quot;</span><span class="p">,</span> <span class="s2">&quot;SellerID_old&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;CarID_old&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">left_join</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="c1">#Relativno posporo resenie od df.to_dict(&#39;records&#39;), megjutoa za razlika od nego gi ignorira NaN vrednostite.</span>
    <span class="n">clean_dict_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No ads to be inserted&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">list_of_sellers_dfs</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Loaded_in_DW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">df_old</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">sellers</span><span class="o">.</span><span class="n">find</span><span class="p">({})))</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_old</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">old_sellers</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SellerID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_old</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span> <span class="s2">&quot;SellerID&quot;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span><span class="s2">&quot;SellerID_old&quot;</span> <span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">left_join</span> <span class="o">=</span> <span class="n">left_join</span><span class="p">[</span><span class="n">left_join</span><span class="p">[</span><span class="s1">&#39;SellerID_old&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>    
    <span class="n">df</span> <span class="o">=</span> <span class="n">left_join</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="c1">#  Relativno posporo resenie od df.to_dict(&#39;records&#39;), megjutoa za razlika od nego gi ignorira NaN vrednostite.</span>
    <span class="n">clean_dict_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No sellers to be inserted&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">cars_database</span><span class="o">.</span><span class="n">sellers</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">clean_dict_list</span><span class="p">)</span>
        
        
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FINISHED&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

 


    </main>
    